#!/usr/bin/with-contenv bashio
# install app
if [ ! -e "${NEXTCLOUD_PATH}/index.php" ]; then
	bashio::log.info "Installing Nextcloud, this can take a while...."
	mkdir -p /data/nextcloud
	mkdir -p /data/nextcloud_data
	tar xf /app/nextcloud.tar.bz2 -C \
		"${NEXTCLOUD_PATH}" --strip-components=1
	chmod +x "${NEXTCLOUD_PATH}/occ"

	chown -R root:root /data/nextcloud /data/nextcloud_data

	bashio::log.info "Initial Nextcloud setup...."
    cp /defaults/config.php /data/nextcloud/config/
	cp /defaults/autoconfig.php /data/nextcloud/config/

	DBPASS=$(bashio::services "mysql" "password")
	DBUSER=$(bashio::services "mysql" "username")
	DBHOST=$(bashio::services "mysql" "host")
	DBPORT=$(bashio::services "mysql" "port")

	sed -i -- "s/HADBUSER/$DBUSER/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBPASS/$DBPASS/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBHOST/$DBHOST/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBPORT/$DBPORT/g" /data/nextcloud/config/autoconfig.php
fi