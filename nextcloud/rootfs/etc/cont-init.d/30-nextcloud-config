#!/usr/bin/with-contenv bashio
# install app
if [ ! -e "${NEXTCLOUD_PATH}/index.php" ]; then
	bashio::log.info "Installing Nextcloud, this can take a while...."
	mkdir -p /data/nextcloud
	mkdir -p /data/nextcloud_data
	tar xf /app/nextcloud.tar.bz2 -C \
		"${NEXTCLOUD_PATH}" --strip-components=1
	chmod +x "${NEXTCLOUD_PATH}/occ"

	chown -R root:root /data/nextcloud /data/nextcloud_data

	bashio::log.info "Initial Nextcloud setup...."
    cp /defaults/config.php /data/nextcloud/config/
	cp /defaults/autoconfig.php /data/nextcloud/config/

	DBPASS=$(bashio::services "mysql" "password")
	DBUSER=$(bashio::services "mysql" "username")
	DBHOST=$(bashio::services "mysql" "host")
	DBPORT=$(bashio::services "mysql" "port")

	sed -i -- "s/HADBUSER/$DBUSER/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBPASS/$DBPASS/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBHOST/$DBHOST/g" /data/nextcloud/config/autoconfig.php
	sed -i -- "s/HADBPORT/$DBPORT/g" /data/nextcloud/config/autoconfig.php
fi

if bashio::config.has_value 'trusted_domains'; then
	bashio::log.info "Adding trusted domains...."
	#reset
	php /data/nextcloud/occ config:system:set trusted_domains
	#populate
	NC_TRUSTED_DOMAIN_IDX=1
	while read -r key; do
		php /data/nextcloud/occ config:system:set trusted_domains $NC_TRUSTED_DOMAIN_IDX --value=$key
		NC_TRUSTED_DOMAIN_IDX=$(($NC_TRUSTED_DOMAIN_IDX+1))
	done <<< "$(bashio::config 'trusted_domains')"
fi